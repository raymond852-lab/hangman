<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰æ¡‚ç‹—è½é»˜ç‰¹è¨“</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        :root { --cinna-blue: #b3e5fc; --cinna-pink: #ffc1e3; --bg: #f9feff; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; text-align: center; overflow: hidden; }
        
        .header { background: white; border-radius: 20px; padding: 10px; border: 3px solid var(--cinna-blue); margin-bottom: 10px; }
        .hero-img { width: 80px; height: 80px; margin: 0 auto; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M20,50 Q20,30 50,30 T80,50 T50,70 T20,50' fill='%23fff' stroke='%23b3e5fc' stroke-width='3'/%3E%3Ccircle cx='40' cy='48' r='3' fill='%235d5d5d'/%3E%3Ccircle cx='60' cy='48' r='3' fill='%235d5d5d'/%3E%3Cpath d='M45,58 Q50,62 55,58' stroke='%23ffc1e3' fill='none' stroke-width='2'/%3E%3Cpath d='M10,45 Q5,35 15,30 Q25,25 30,40' fill='%23fff' stroke='%23b3e5fc' stroke-width='2'/%3E%3Cpath d='M90,45 Q95,35 85,30 Q75,25 70,40' fill='%23fff' stroke='%23b3e5fc' stroke-width='2'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; }

        .input-panel { background: white; border-radius: 20px; padding: 20px; border: 2px dashed var(--cinna-blue); }
        #dictation-input { width: 100%; border: none; font-size: 1.4rem; border-bottom: 2px solid var(--cinna-blue); margin-bottom: 20px; outline: none; text-align: center; padding: 10px 0; }
        .start-btn { background: var(--cinna-pink); color: white; border: none; padding: 18px; border-radius: 50px; font-weight: 900; font-size: 1.5rem; width: 100%; box-shadow: 0 5px 0 #f06292; cursor: pointer; }

        .word-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .word-tile { width: 60px; height: 60px; background: white; border: 3px solid var(--cinna-blue); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #546e7a; position: relative; }
        .tile-hide { visibility: hidden; }
        .word-tile.done { border-color: var(--cinna-pink); background: #fff0f5; visibility: visible !important; }

        /* å…¨è¢å¹•ç·´ç¿’è¦–çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #writer-canvas { border: 5px solid #f0faff; border-radius: 30px; width: 340px; height: 340px; margin: 20px 0; background: #fff; cursor: crosshair; }
        .hint-text { color: var(--cinna-blue); font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        .speaker-icon { font-size: 3rem; margin-bottom: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="setup-ui">
        <div class="header">
            <div class="hero-img"></div>
            <h3 style="margin:5px 0; color: #78909c;">ç‰æ¡‚ç‹—ï¼šLevel 2 å…¨è‡ªå‹•é»˜å¯«</h3>
        </div>
        <div class="input-panel">
            <input type="text" id="dictation-input" placeholder="è«‹è¼¸å…¥é»˜å¯«å¥å­..." />
            <button class="start-btn" onclick="startFlow()">ğŸš€ ç›´æ¥é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <div id="practice-ui" style="display:none;">
        <div class="word-grid" id="grid"></div>
        <button onclick="location.reload()" style="margin-top:50px; border:none; background:none; color:#ccc; text-decoration:underline; font-size:1rem;">åœæ­¢ä¸¦è¿”å›</button>
    </div>

    <div id="modal" class="modal">
        <div class="speaker-icon" onclick="sayWord()">ğŸ¶ğŸ”Š</div>
        <div class="hint-text">è«‹è½éŸ³é»˜å¯«</div>
        <div id="writer-canvas"></div>
        <div style="color:#ddd; font-size:0.9rem;">å¯«å®Œæ­£ç¢ºç­†åŠƒæœƒè‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹å­—</div>
    </div>

    <script>
        let chars = [];
        let activeIdx = 0;
        let writer = null;

        function startFlow() {
            const val = document.getElementById('dictation-input').value.trim();
            if(!val) return;
            chars = val.split('');
            document.getElementById('setup-ui').style.display = 'none';
            document.getElementById('practice-ui').style.display = 'block';
            
            // åˆå§‹åŒ–åº•å±¤æ ¼å­
            const g = document.getElementById('grid'); g.innerHTML = '';
            chars.forEach((c, i) => {
                const d = document.createElement('div');
                d.className = 'word-tile tile-hide';
                d.id = 't-' + i;
                if(/[ï¼Œã€‚ï¼ï¼Ÿã€\s]/.test(c)) { d.innerHTML = c; d.style.border = 'none'; d.classList.add('done'); }
                g.appendChild(d);
            });

            activeIdx = 0;
            nextStep();
        }

        function nextStep() {
            // è·³éæ¨™é»ç¬¦è™Ÿ
            while(activeIdx < chars.length && /[ï¼Œã€‚ï¼ï¼Ÿã€\s]/.test(chars[activeIdx])) {
                activeIdx++;
            }

            if(activeIdx < chars.length) {
                runQuiz(chars[activeIdx], activeIdx);
            } else {
                document.getElementById('modal').style.display = 'none';
                alert("ğŸ­ å¤ªæ£’äº†ï¼å…¨éƒ¨å¯«å®Œå–‡ï¼");
            }
        }

        function runQuiz(char, index) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('writer-canvas').innerHTML = '';
            
            // å»ºç«‹å¯«å­—å°è±¡
            writer = HanziWriter.create('writer-canvas', char, {
                width: 340,
                height: 340,
                padding: 30,
                showOutline: false,    // çµ•å°ä¸é¡¯ç¤ºè¼ªå»“
                showCharacter: false,  // çµ•å°ä¸é¡¯ç¤ºç­”æ¡ˆ
                strokeColor: '#5d5d5d',
                drawingWidth: 35,
                drawingColor: '#333'
            });

            // 1. è‡ªå‹•æœ—è®€
            setTimeout(() => { sayWord(); }, 300);

            // 2. è‡ªå‹•å•Ÿå‹•é»˜å¯«æ¨¡å¼ (ä¸éœ€è¦æŒ‰æŒ‰éˆ•)
            writer.quiz({
                onComplete: function() {
                    // å¯«å®Œå¾Œæ›´æ–°åº•å±¤æ ¼å­
                    const tile = document.getElementById('t-' + index);
                    tile.innerHTML = char;
                    tile.classList.add('done');
                    
                    // 3. è‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹å­—
                    setTimeout(() => {
                        activeIdx++;
                        nextStep();
                    }, 600);
                }
            });
        }

        function sayWord() {
            const u = new SpeechSynthesisUtterance(chars[activeIdx]);
            u.lang = 'zh-HK';
            u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
